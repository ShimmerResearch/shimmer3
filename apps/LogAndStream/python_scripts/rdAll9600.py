 #!/usr/bin/python
import sys, struct, serial
import binascii, time

CRC_INIT = 0xB0CA

UART_PROP_ENABLE           = 0x00 # this is for all sensors
UART_PROP_SAMPLE_RATE      = 0x01
UART_PROP_MAC              = 0x02
UART_PROP_VER              = 0x03
UART_PROP_RWC_CFG_TIME     = 0x04
UART_PROP_CURR_LOCAL_TIME  = 0x05
UART_PROP_INFOMEM          = 0x06
UART_PROP_VALUE            = 0x02
UART_PROP_CARD_ID          = 0x02
UART_PROP_CARD_MEM         = 0x03

def crcByte(crc, b):
	crc = ((crc >> 8)&0xffff | (crc << 8)&0xffff)&0xffff
	crc ^= (b)&0xffff
	crc ^= ((crc & 0xff) >> 4)&0xffff
	crc ^= (crc << 12)&0xffff
	crc ^= ((crc & 0xff) << 5)&0xffff
	return crc

def calcCrc(len, msg):
	#uint16_t crcCalc;
	#uint8_t i;
	crcCalc = crcByte(CRC_INIT, msg[0])
	for i in range(1,len):
		crcCalc = crcByte(crcCalc, msg[i])
		
	if len%2==1:
		crcCalc = crcByte(crcCalc, 0x00)

	return crcCalc;

def crcCheck(len, msg):
	#uint16_t crc;

	crc = calcCrc(len-2, msg);
	if(((crc&0xFF) == msg[len-2]) and (((crc&0xFF00)>>8) == msg[len-1])):
		return TRUE;
	else:
		return FALSE;

		
def sendUart(inArg):
   ddata = ""
   inCrc = [0, 0]
   inCrcRaw = calcCrc(len(inArg), inArg)
   inCrc[0] = inCrcRaw&0xff
   inCrc[1] = inCrcRaw>>8
   
   ser.write(inArg)
   ser.write(inCrc)
   time.sleep(0.2)   
   buf_len = ser.inWaiting()
   cnt1=9999
   while buf_len>0:
      if (cnt1==9999):
         if (buf_len >= 5):
            data = ser.read(5)
         else:
            data = ser.read(2)  
         buf_len = ser.inWaiting()    
         print "      0 1 2 3 4 5 6 7 8 9 a b c d e f"
         print "cmd:", binascii.hexlify(data), data
         cnt1 = 0
      else:
         if (buf_len>16):
            ddata = ser.read(16)
            print "0x%02x" % cnt1, binascii.hexlify(ddata) , ddata
            buf_len = buf_len - 16;
         elif(buf_len>2):
            ddata = ser.read(buf_len-2)
            print "0x%02x" % cnt1, binascii.hexlify(ddata) , ddata
            buf_len = 2;
         else:
            ddata = ser.read(buf_len)# for crc 2 bytes
            print "crc:", binascii.hexlify(ddata) , ddata
            buf_len = 0;
         cnt1 = cnt1 + 16;

   time.sleep(0.1)           
   return
   
def wait_for_ack():
   ddata = ""
   ack = struct.pack('B', 0xff)
   while ddata != ack:
      ddata = ser.read(1)
      print "0x%02x" % ord(ddata[0])
	  
   return
   
if len(sys.argv) < 2:
   print "no device specified"
   print "You need to specify the serial port of the device you wish to connect to"
   print "example:"
   print "   *.py Com12"
   print "or"
   print "   *.py /dev/rfcomm0"
else:
# read incoming data
   ddata = ""
   numbytes = 0
   framesize = 10 # 1byte packet type + 3byte timestamp + 3x2byte Analog Accel
   
   ser = serial.Serial(sys.argv[1], 9600)
   ser.flushInput()
   print "port opening, done."

   #raw_nb = raw_input('Enter a command:')
   #nb = int(raw_nb, 0)
   framesize = 4
      
   ddata = ""
    
   print "---------------------------------------- mac: " 
   inArg = [0x24, 0x03, 0x02, 0x01, UART_PROP_MAC]  
   sendUart(inArg) 
   print "---------------------------------------- ver: " 
   inArg = [0x24, 0x03, 0x02, 0x01, UART_PROP_VER]  
   sendUart(inArg)   
   print "---------------------------------------- bat: " 
   inArg = [0x24, 0x03, 0x02, 0x02, UART_PROP_VALUE]  
   sendUart(inArg)   
   print "---------------------------------------- cfg time read: " 
   inArg = [0x24, 0x03, 0x02, 0x01, UART_PROP_RWC_CFG_TIME]  
   sendUart(inArg)   
   print "---------------------------------------- cfg time wr: " 
   inArg = [0x24, 0x01, 0x0a, 0x01, UART_PROP_RWC_CFG_TIME, 0x00, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77]  
   sendUart(inArg)   
   print "---------------------------------------- cfg time read again: " 
   inArg = [0x24, 0x03, 0x02, 0x01, UART_PROP_RWC_CFG_TIME]  
   sendUart(inArg)   
   print "---------------------------------------- curr time read: " 
   inArg = [0x24, 0x03, 0x02, 0x01, UART_PROP_CURR_LOCAL_TIME]  
   sendUart(inArg)   
   print "---------------------------------------- Daughter Card ID get: " 
   inArg = [0x24, 0x03, 0x04, 0x03, UART_PROP_CARD_ID, 0x10, 0x00]  
   sendUart(inArg)  
   print "---------------------------------------- Daughter Card Mem get: " 
   inArg = [0x24, 0x03, 0x05, 0x03, UART_PROP_CARD_MEM, 0x80, 0x00, 0x00]  
   sendUart(inArg)  
   print "---------------------------------------- info Mem D Set: " 
   inArg = [0x24, 0x01, 0x85, 0x01, UART_PROP_INFOMEM, 0x80, 0x00, 0x18, 
   0x60, 0x02, 0x01, 0xc0, 0x20, 0x00, 0x5c, 0x9b, 0x39, 0x00, 0x02, 0x80, 0x10, 0x00, 0x00, 0x00, 
   0x00, 0x00, 0x00, 0x02, 0x02, 0x80, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xee, 
   0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
   0xdd, 0xdd, 0xdd, 0xcc, 0xbb, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
   0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0x99, 0x88, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 
   0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x66, 0x55, 0x44, 
   0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 
   0x44, 0x44, 0x33, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff]  
   #sendUart(inArg) 
   print "---------------------------------------- info Mem C Set: " 
   inArg = [0x24, 0x01, 0x85, 0x01, UART_PROP_INFOMEM, 0x80, 0x80, 0x18, 
   0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, ord('c'), ord('b'), ord('c'), ord('d'), ord('e'), 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, ord('c'), ord('2'), ord('3'), ord('4'), ord('5'), 0xff, 0xff, 0xff, 0xff, 
   0xff, 0xff, 0xff, 0x01, 0x23, 0x45, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
   0x12, 0x34, 0x56, 0x78, 0x90, 0xab, 0x02, ord('a'), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff]
   #sendUart(inArg) 
   print "---------------------------------------- info Mem B Set: " 
   inArg = [0x24, 0x01, 0x85, 0x01, UART_PROP_INFOMEM, 0x80, 0x00, 0x19, 
   0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff] 
   #sendUart(inArg) 
   print "---------------------------------------- info Mem D get: " 
   inArg = [0x24, 0x03, 0x05, 0x01, UART_PROP_INFOMEM, 0x80, 0x00, 0x18] 
   sendUart(inArg) 
   print "---------------------------------------- info Mem C get: " 
   inArg = [0x24, 0x03, 0x05, 0x01, UART_PROP_INFOMEM, 0x80, 0x80, 0x18] 
   sendUart(inArg) 
   print "---------------------------------------- info Mem B get: " 
   inArg = [0x24, 0x03, 0x05, 0x01, UART_PROP_INFOMEM, 0x80, 0x00, 0x19] 
   sendUart(inArg) 
         
	  
print 'All done'
